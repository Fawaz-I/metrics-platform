name: Load Test
on:
  workflow_dispatch:
  schedule:
    - cron: '0 2 * * 0'

jobs:
  jmeter:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    
    - name: Install JMeter
      run: |
        sudo apt-get update
        sudo apt-get install -y wget
        wget https://dlcdn.apache.org//jmeter/binaries/apache-jmeter-5.6.3.tgz
        tar -xzf apache-jmeter-5.6.3.tgz
        echo "$(pwd)/apache-jmeter-5.6.3/bin" >> $GITHUB_PATH
    
    - name: Start Environment
      run: |
        docker compose -f metrics-platform-api/docker-compose.yml up -d postgres
        
        sleep 10
        
        docker build -t metrics-platform-api:latest -f metrics-platform-api/Dockerfile .
        
        docker compose -f metrics-platform-api/docker-compose.yml up -d api
        
        timeout 60s bash -c 'until curl -s http://localhost:8080/actuator/health | grep UP; do sleep 2; done'
    
    - name: Run JMeter tests
      env:
        CI: true
      run: ./scripts/run-jmeter-tests.sh
    
    - name: Archive Test Report
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: jmeter-report
        path: test-reports/
